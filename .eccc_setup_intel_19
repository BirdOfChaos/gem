#!/bin/bash

# Source this file to:
# - Load the Intel 16 compiler and libraries
# - Add a symbolic link for gem_dbase
# - Create the build directory for the specific compiler version

[[ $0 != $BASH_SOURCE ]] || (echo "This file must be sourced!" && exit 1)


if [ "$TRUE_HOST" = "banting" -o "$TRUE_HOST" = "daley" ]; then
   module swap PrgEnv-cray PrgEnv-intel
   module load craype-x86-skylake
else
   . ssmuse-sh -x comm/eccc/all/opt/intelcomp/intelpsxe-cluster-19.0.3.199
   . ssmuse-sh -x hpco/exp/openmpi/openmpi-3.1.2--hpcx-2.4.0-mofed-4.6--intel-19.0.3.199
   . ssmuse-sh -x hpco/exp/openmpi-setup/openmpi-setup-0.2
fi


if [ `hostname -d` = "cmc.ec.gc.ca" ]; then
   GEM_DBASE=/home/ordenv/ssm-domains9/release/gem-data_4.2.0/gem-data_4.2.0_all/share/data/dfiles;
   [ -e ${GEM_DBASE} ] && [ ! -e gem_dbase ] && ln -sf ${GEM_DBASE} gem_dbase;
else
   if [ `hostname -d` = "science.gc.ca" ]; then
      GEM_DBASE=/fs/ssm/eccc/mrd/rpn/MIG/GEM/d/gem-data/gem-data_4.2.0/gem-data_4.2.0_all/share/data/dfiles;
      [ -e ${GEM_DBASE} ] && [ ! -e gem_dbase ] && ln -sf ${GEM_DBASE} gem_dbase;
   fi
fi

rootPath="$(dirname $BASH_SOURCE)"

compVersion=$("${rootPath}/project/compiler.sh" intel)
sed -i 's/COMPILER gfortran/COMPILER intel/g' "${rootPath}/project/CMakeLists.txt"
majorVersion=${compVersion%%.*}
/bin/rm "${rootPath}/project/Linux-x86_64-intel.cmake"
ln -s Linux-x86_64-intel.cmake.${majorVersion} "${rootPath}/project/Linux-x86_64-intel.cmake"

buildDir="${rootPath}/build/intel-${compVersion}"
echo mkdir -p "${buildDir}"
mkdir -p "${buildDir}"

sed -i s"/.*cmake.buildDirectory.*/           \"cmake.buildDirectory\": \"\${workspaceRoot}\/build\/intel-$compVersion\",/" "${rootPath}/goas-devel.code-workspace"

unset buildDir majorVersion compVersion rootPath
